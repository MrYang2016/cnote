# Phase 3 æŠ€æœ¯å®ç°æ€»ç»“

**æ—¥æœŸ**: 2025-10-24  
**ä¸»é¢˜**: å¥½å‹ç³»ç»Ÿ & ç¬”è®°å…±äº«  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## æ¦‚è¿°

Phase 3 åœ¨ Phase 1ï¼ˆåŸºç¡€ç¬”è®°ç³»ç»Ÿï¼‰å’Œ Phase 2ï¼ˆAI èŠå¤©ï¼‰çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†ç¤¾äº¤åä½œåŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥æ·»åŠ å¥½å‹ã€å…±äº«ç¬”è®°ï¼Œå¹¶é€šè¿‡ MCP åè®®æä¾›æ ‡å‡†åŒ–çš„æ•°æ®è®¿é—®æ¥å£ã€‚

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (Next.js)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¥½å‹ç®¡ç†é¡µé¢  â”‚  å…±äº«ç¬”è®°é¡µé¢  â”‚  ç¬”è®°ç¼–è¾‘é¡µé¢ï¼ˆå¢å¼ºï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                 â”‚
           â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API å±‚ (Next.js API Routes)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Friends API  â”‚  Shares API  â”‚   MCP APIs   â”‚ Chat API  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚              â”‚            â”‚
       â–¼              â–¼              â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸šåŠ¡é€»è¾‘å±‚ (lib/db/*, lib/mcp/*)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   friends.ts â”‚   shares.ts  â”‚ *-server.ts  â”‚  chat.ts  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚              â”‚            â”‚
       â–¼              â–¼              â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®åº“å±‚ (Supabase PostgreSQL + pgvector)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   friends    â”‚ note_shares  â”‚friend_requestsâ”‚   RLS     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®åº“è®¾è®¡

### æ–°å¢è¡¨ç»“æ„

#### 1. friends è¡¨

```sql
CREATE TABLE friends (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES profiles(id),
  friend_id uuid REFERENCES profiles(id),
  created_at timestamptz,
  UNIQUE(user_id, friend_id),
  CHECK (user_id != friend_id)
);
```

**è®¾è®¡è¦ç‚¹ï¼š**
- åŒå‘å…³ç³»ï¼šA å’Œ B æ˜¯å¥½å‹æ—¶ï¼Œä¼šåˆ›å»ºä¸¤æ¡è®°å½•
- å”¯ä¸€çº¦æŸï¼šé˜²æ­¢é‡å¤æ·»åŠ 
- æ£€æŸ¥çº¦æŸï¼šé˜²æ­¢è‡ªå·±åŠ è‡ªå·±

#### 2. friend_requests è¡¨

```sql
CREATE TABLE friend_requests (
  id uuid PRIMARY KEY,
  from_user_id uuid REFERENCES profiles(id),
  to_user_id uuid REFERENCES profiles(id),
  status text CHECK (status IN ('pending', 'accepted', 'rejected')),
  created_at timestamptz,
  updated_at timestamptz,
  UNIQUE(from_user_id, to_user_id)
);
```

**çŠ¶æ€æœºï¼š**
```
pending â†’ accepted (åˆ›å»ºå¥½å‹å…³ç³»)
pending â†’ rejected (æ ‡è®°ä¸ºå·²æ‹’ç»)
pending â†’ deleted (å–æ¶ˆè¯·æ±‚)
```

#### 3. note_shares è¡¨

```sql
CREATE TABLE note_shares (
  id uuid PRIMARY KEY,
  note_id uuid REFERENCES notes(id),
  owner_id uuid REFERENCES profiles(id),
  shared_with_user_id uuid REFERENCES profiles(id),
  permission text CHECK (permission IN ('read', 'write')),
  created_at timestamptz,
  UNIQUE(note_id, shared_with_user_id)
);
```

**æƒé™æ¨¡å‹ï¼š**
- **read**: åªèƒ½æŸ¥çœ‹ç¬”è®°
- **write**: å¯ä»¥ç¼–è¾‘ç¬”è®°ï¼ˆä½†ä¸èƒ½åˆ é™¤ï¼‰

### RLS ç­–ç•¥

Phase 3 ä¸ºæ‰€æœ‰æ–°è¡¨å®ç°äº†å®Œæ•´çš„ Row Level Security ç­–ç•¥ï¼š

**friends è¡¨ï¼š**
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„å¥½å‹å…³ç³»
- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„å¥½å‹
- åªèƒ½é€šè¿‡å‡½æ•°æ’å…¥ï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰

**friend_requests è¡¨ï¼š**
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å‘é€ç»™è‡ªå·±æˆ–è‡ªå·±å‘é€çš„è¯·æ±‚
- ç”¨æˆ·å¯ä»¥å‘é€è¯·æ±‚
- åªæœ‰æ¥æ”¶æ–¹å¯ä»¥æ›´æ–°è¯·æ±‚
- åªæœ‰å‘é€æ–¹å¯ä»¥åˆ é™¤å¾…å¤„ç†è¯·æ±‚

**note_shares è¡¨ï¼š**
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±åˆ†äº«çš„å’Œåˆ«äººåˆ†äº«ç»™è‡ªå·±çš„
- ç”¨æˆ·å¯ä»¥åˆ†äº«è‡ªå·±çš„ç¬”è®°ï¼ˆä»…é™å¥½å‹ï¼‰
- ç”¨æˆ·å¯ä»¥å–æ¶ˆåˆ†äº«
- ç”¨æˆ·å¯ä»¥æ›´æ–°åˆ†äº«æƒé™

### æ•°æ®åº“å‡½æ•°

#### accept_friend_request()

```sql
CREATE FUNCTION accept_friend_request(request_id uuid)
RETURNS json AS $$
-- éªŒè¯è¯·æ±‚
-- æ›´æ–°è¯·æ±‚çŠ¶æ€
-- åˆ›å»ºåŒå‘å¥½å‹å…³ç³»
-- è¿”å›ç»“æœ
$$;
```

**ç‰¹ç‚¹ï¼š**
- äº‹åŠ¡æ€§æ“ä½œ
- åŸå­æ€§ä¿è¯
- å®‰å…¨æ€§éªŒè¯

#### get_shared_notes()

```sql
CREATE FUNCTION get_shared_notes(p_user_id uuid)
RETURNS TABLE (...) AS $$
-- æŸ¥è¯¢ note_shares
-- JOIN notes å’Œ profiles
-- è¿”å›å®Œæ•´ä¿¡æ¯
$$;
```

**ä¼˜åŠ¿ï¼š**
- ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰ä¿¡æ¯
- åŒ…å«æ‰€æœ‰è€…ä¿¡æ¯
- æœåŠ¡å™¨ç«¯è¿‡æ»¤

#### æ›´æ–° search_notes()

```sql
CREATE FUNCTION search_notes(query_embedding vector(1024), ...)
RETURNS TABLE (...) AS $$
-- æœç´¢ä¸ªäººç¬”è®°
-- æœç´¢å…±äº«ç¬”è®°
-- æ ‡æ³¨æ¥æº
-- è¿”å›ç»¼åˆç»“æœ
$$;
```

**å¢å¼ºåŠŸèƒ½ï¼š**
- åŒæ—¶æœç´¢ä¸ªäººå’Œå…±äº«ç¬”è®°
- æ·»åŠ  `is_own_note` å­—æ®µ
- æ·»åŠ  `owner_username` å­—æ®µ
- ä¿æŒé«˜æ€§èƒ½ï¼ˆä½¿ç”¨ HNSW ç´¢å¼•ï¼‰

---

## åç«¯å®ç°

### å¥½å‹ç³»ç»Ÿ (lib/db/friends.ts)

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

1. **å‘é€å¥½å‹è¯·æ±‚**
```typescript
export async function sendFriendRequest(toUsername: string)
- æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·
- éªŒè¯ä¸æ˜¯è‡ªå·±
- æ£€æŸ¥æ˜¯å¦å·²æ˜¯å¥½å‹
- æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯·æ±‚
- åˆ›å»ºæ–°è¯·æ±‚
```

2. **æ¥å—å¥½å‹è¯·æ±‚**
```typescript
export async function acceptFriendRequest(requestId: string)
- è°ƒç”¨æ•°æ®åº“å‡½æ•°
- è‡ªåŠ¨åˆ›å»ºåŒå‘å…³ç³»
- æ›´æ–°è¯·æ±‚çŠ¶æ€
```

3. **è·å–å¥½å‹åˆ—è¡¨**
```typescript
export async function getFriends()
- è°ƒç”¨ get_friends_with_profiles()
- è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯
```

**è®¾è®¡æ¨¡å¼ï¼š**
- Repository æ¨¡å¼
- é”™è¯¯ç»Ÿä¸€å¤„ç†
- TypeScript ç±»å‹å®‰å…¨

### ç¬”è®°å…±äº« (lib/db/shares.ts)

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

1. **å…±äº«ç¬”è®°**
```typescript
export async function shareNoteWithFriend(
  noteId: string,
  friendId: string,
  permission: 'read' | 'write'
)
- éªŒè¯ç¬”è®°æ‰€æœ‰æƒ
- éªŒè¯å¥½å‹å…³ç³»
- åˆ›å»ºæˆ–æ›´æ–°å…±äº«
```

2. **æ‰¹é‡å…±äº«**
```typescript
export async function shareNoteWithMultipleFriends(
  noteId: string,
  friendIds: string[],
  permission: 'read' | 'write'
)
- å¾ªç¯è°ƒç”¨å•ä¸ªå…±äº«
- ç»Ÿè®¡æˆåŠŸæ•°é‡
- è¿”å›ç»“æœæ‘˜è¦
```

3. **æ£€æŸ¥è®¿é—®æƒé™**
```typescript
export async function checkNoteAccess(noteId: string)
- æ£€æŸ¥æ˜¯å¦æ˜¯æ‰€æœ‰è€…
- æ£€æŸ¥å…±äº«æƒé™
- è¿”å›å®Œæ•´æƒé™ä¿¡æ¯
```

**å®‰å…¨æ€§ï¼š**
- æ¯ä¸ªæ“ä½œéƒ½éªŒè¯æƒé™
- RLS ç­–ç•¥åŒé‡ä¿æŠ¤
- é˜²æ­¢æ•°æ®æ³„éœ²

### MCP Server

#### Private MCP Server (lib/mcp/private-server.ts)

**Resources:**
```typescript
listResources(userId) â†’ [
  { uri: 'note://uuid', name: 'Note Title', ... }
]
readResource(uri, userId) â†’ { contents: '...', mimeType: '...' }
```

**Tools:**
- `search_notes` - æœç´¢ä¸ªäººç¬”è®°
- `get_note` - è·å–ç¬”è®°è¯¦æƒ…
- `list_recent_notes` - åˆ—å‡ºæœ€è¿‘ç¬”è®°

**Prompts:**
- `summarize_notes` - æ€»ç»“ç¬”è®°
- `find_related` - æŸ¥æ‰¾ç›¸å…³ç¬”è®°

#### Shared MCP Server (lib/mcp/shared-server.ts)

**Resources:**
```typescript
listResources(userId) â†’ [
  { uri: 'shared://uuid', name: 'Shared Note', description: 'by @user' }
]
```

**Tools:**
- `search_shared_notes` - æœç´¢å…±äº«ç¬”è®°
- `get_shared_note` - è·å–å…±äº«ç¬”è®°è¯¦æƒ…
- `list_shared_notes` - åˆ—å‡ºæ‰€æœ‰å…±äº«ç¬”è®°
- `list_by_friend` - æŒ‰å¥½å‹ç­›é€‰

**ç‰¹ç‚¹ï¼š**
- æ ‡å‡† MCP åè®®å®ç°
- æƒé™éªŒè¯å†…ç½®
- æ¸…æ™°çš„èµ„æºå‘½åï¼ˆnote:// vs shared://ï¼‰

---

## å‰ç«¯å®ç°

### ç»„ä»¶æ¶æ„

```
components/
â”œâ”€â”€ friends/
â”‚   â”œâ”€â”€ FriendsList.tsx          # å¥½å‹åˆ—è¡¨
â”‚   â”œâ”€â”€ FriendRequests.tsx       # å¥½å‹è¯·æ±‚ï¼ˆæ”¶åˆ°/å‘é€ï¼‰
â”‚   â””â”€â”€ AddFriendDialog.tsx      # æ·»åŠ å¥½å‹å¯¹è¯æ¡†
â””â”€â”€ notes/
    â”œâ”€â”€ ShareNoteDialog.tsx      # åˆ†äº«ç¬”è®°å¯¹è¯æ¡†
    â””â”€â”€ SharedNotesList.tsx      # å…±äº«ç¬”è®°åˆ—è¡¨
```

### å…³é”®ç»„ä»¶

#### FriendsList

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
- åˆ é™¤å¥½å‹
- åŠ è½½çŠ¶æ€

**UX ä¼˜åŒ–ï¼š**
- ç©ºçŠ¶æ€æç¤º
- åŠ è½½åŠ¨ç”»
- ç¡®è®¤å¯¹è¯æ¡†

#### FriendRequests

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºæ”¶åˆ°çš„è¯·æ±‚ï¼ˆå¯æ¥å—/æ‹’ç»ï¼‰
- æ˜¾ç¤ºå‘é€çš„è¯·æ±‚ï¼ˆå¯å–æ¶ˆï¼‰
- åˆ†æ ‡ç­¾é¡µå±•ç¤º

**å®æ—¶æ›´æ–°ï¼š**
- æ“ä½œåè‡ªåŠ¨åˆ·æ–°
- Custom Event é€šçŸ¥çˆ¶ç»„ä»¶

#### ShareNoteDialog

**åŠŸèƒ½ï¼š**
- é€‰æ‹©å¥½å‹ï¼ˆå¤šé€‰ï¼‰
- è®¾ç½®æƒé™
- æ˜¾ç¤ºå·²å…±äº«çŠ¶æ€

**äº¤äº’è®¾è®¡ï¼š**
- ç‚¹å‡»å¡ç‰‡é€‰æ‹©
- é€‰ä¸­çŠ¶æ€å¯è§†åŒ–
- å·²å…±äº«å¥½å‹ç½®ç°

#### SharedNotesList

**åŠŸèƒ½ï¼š**
- å¡ç‰‡å¼å¸ƒå±€
- æ˜¾ç¤ºæ‰€æœ‰è€…ä¿¡æ¯
- æƒé™å›¾æ ‡

**å“åº”å¼è®¾è®¡ï¼š**
- ç§»åŠ¨ç«¯ï¼š1 åˆ—
- å¹³æ¿ï¼š2 åˆ—
- æ¡Œé¢ï¼š3 åˆ—

### é¡µé¢

#### /friends

```tsx
<Tabs>
  <Tab value="friends">
    <FriendsList />
  </Tab>
  <Tab value="requests">
    <FriendRequests />
  </Tab>
</Tabs>
<AddFriendDialog />
```

**ç‰¹ç‚¹ï¼š**
- æ ‡ç­¾é¡µåˆ‡æ¢
- æœç´¢æ·»åŠ å¥½å‹
- ç»Ÿä¸€çš„æ“ä½œå…¥å£

#### /shared

```tsx
<SharedNotesList />
```

**ç‰¹ç‚¹ï¼š**
- ä¸“é—¨çš„å…±äº«ç¬”è®°é¡µé¢
- æ¸…æ™°çš„æ‰€æœ‰æƒæ ‡è¯†
- å¿«é€Ÿè®¿é—®

---

## API è®¾è®¡

### RESTful API

#### Friends API

| Method | Endpoint | åŠŸèƒ½ |
|--------|----------|------|
| GET | `/api/friends?type=friends` | è·å–å¥½å‹åˆ—è¡¨ |
| GET | `/api/friends?type=received` | è·å–æ”¶åˆ°çš„è¯·æ±‚ |
| GET | `/api/friends?type=sent` | è·å–å‘é€çš„è¯·æ±‚ |
| GET | `/api/friends?type=search&query=...` | æœç´¢ç”¨æˆ· |
| POST | `/api/friends` | å‘é€å¥½å‹è¯·æ±‚ |
| PATCH | `/api/friends` | æ¥å—/æ‹’ç»/å–æ¶ˆè¯·æ±‚ |
| DELETE | `/api/friends?friendId=...` | åˆ é™¤å¥½å‹ |

#### Shares API

| Method | Endpoint | åŠŸèƒ½ |
|--------|----------|------|
| GET | `/api/shares?type=note&noteId=...` | è·å–ç¬”è®°å…±äº«åˆ—è¡¨ |
| GET | `/api/shares?type=shared-with-me` | è·å–å…±äº«ç»™æˆ‘çš„ç¬”è®° |
| GET | `/api/shares?type=access&noteId=...` | æ£€æŸ¥è®¿é—®æƒé™ |
| POST | `/api/shares` | å…±äº«ç¬”è®° |
| PATCH | `/api/shares` | æ›´æ–°å…±äº«æƒé™ |
| DELETE | `/api/shares?shareId=...` | å–æ¶ˆå…±äº« |

### MCP API

#### åè®®æ ¼å¼

**è¯·æ±‚ï¼š**
```json
{
  "method": "tools/call",
  "params": {
    "name": "search_notes",
    "arguments": {
      "query": "AI",
      "limit": 5
    }
  }
}
```

**å“åº”ï¼š**
```json
{
  "result": {
    "results": [...]
  }
}
```

#### æ”¯æŒçš„æ–¹æ³•

| Method | åŠŸèƒ½ |
|--------|------|
| `initialize` | è·å–æœåŠ¡å™¨ä¿¡æ¯ |
| `resources/list` | åˆ—å‡ºæ‰€æœ‰èµ„æº |
| `resources/read` | è¯»å–èµ„æºå†…å®¹ |
| `tools/list` | åˆ—å‡ºæ‰€æœ‰å·¥å…· |
| `tools/call` | è°ƒç”¨å·¥å…· |
| `prompts/list` | åˆ—å‡ºæ‰€æœ‰æç¤ºè¯ |
| `prompts/get` | è·å–æç¤ºè¯ |

---

## AI èŠå¤©å¢å¼º

### æ›´æ–°çš„æœç´¢é€»è¾‘

**ä¹‹å‰ï¼ˆPhase 2ï¼‰ï¼š**
```typescript
// åªæœç´¢ä¸ªäººç¬”è®°
const relevantNotes = await searchSimilarNotes(userId, embedding)
```

**ç°åœ¨ï¼ˆPhase 3ï¼‰ï¼š**
```typescript
// æœç´¢ä¸ªäºº + å…±äº«ç¬”è®°ï¼ˆæ•°æ®åº“å‡½æ•°å·²æ›´æ–°ï¼‰
const relevantNotes = await searchSimilarNotes(userId, embedding)
// ç»“æœåŒ…å« is_own_note å’Œ owner_username å­—æ®µ
```

### ä¸Šä¸‹æ–‡æ„å»º

```typescript
relevantNotes.forEach((result, index) => {
  const noteOwner = result.is_own_note 
    ? 'Your note' 
    : `Shared by @${result.owner_username}`;
  context += `[${index + 1}] ${noteOwner} - "${result.note.title}":\n${result.chunk_text}\n\n`;
});
```

### ç³»ç»Ÿæç¤ºè¯

```
You have access to the user's personal notes AND notes shared with them by friends.

When answering:
- Clearly indicate if information comes from a shared note
- Example: "According to a note shared by @username..."
```

**æ•ˆæœï¼š**
- AI è‡ªåŠ¨åŒºåˆ†æ¥æº
- æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡
- æ›´å‡†ç¡®çš„ç­”æ¡ˆ

---

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“å±‚é¢

1. **ç´¢å¼•ä¼˜åŒ–**
```sql
CREATE INDEX friends_user_id_idx ON friends(user_id);
CREATE INDEX friends_friend_id_idx ON friends(friend_id);
CREATE INDEX note_shares_note_id_idx ON note_shares(note_id);
```

2. **æŸ¥è¯¢ä¼˜åŒ–**
- ä½¿ç”¨ JOIN å‡å°‘æŸ¥è¯¢æ¬¡æ•°
- RPC å‡½æ•°æœåŠ¡å™¨ç«¯è¿‡æ»¤
- LIMIT é™åˆ¶ç»“æœæ•°é‡

3. **å‘é‡æœç´¢**
- ä¿æŒ HNSW ç´¢å¼•
- åˆç†çš„ similarity threshold
- é™åˆ¶è¿”å›æ•°é‡ï¼ˆTop Kï¼‰

### API å±‚é¢

1. **æ‰¹é‡æ“ä½œ**
- æ‰¹é‡å…±äº«ç¬”è®°
- å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPromise.allï¼‰

2. **é”™è¯¯å¤„ç†**
- ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- é€‚å½“çš„ HTTP çŠ¶æ€ç 

### å‰ç«¯å±‚é¢

1. **çŠ¶æ€ç®¡ç†**
- æœ¬åœ°çŠ¶æ€ç¼“å­˜
- ä¹è§‚ UI æ›´æ–°
- åŠ è½½çŠ¶æ€åé¦ˆ

2. **ç½‘ç»œä¼˜åŒ–**
- å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚
- è¯·æ±‚åˆå¹¶
- æ•°æ®é¢„åŠ è½½

---

## å®‰å…¨æ€§

### è®¤è¯ä¸æˆæƒ

**ä¸‰å±‚å®‰å…¨ï¼š**

1. **API å±‚**
```typescript
const { data: { user } } = await supabase.auth.getUser()
if (!user) return 401
```

2. **ä¸šåŠ¡é€»è¾‘å±‚**
```typescript
// éªŒè¯æ‰€æœ‰æƒ
if (note.user_id !== user.id) return { error: '...' }
```

3. **æ•°æ®åº“å±‚ï¼ˆRLSï¼‰**
```sql
CREATE POLICY "..." ON notes
  USING (auth.uid() = user_id)
```

### æ•°æ®ä¿æŠ¤

**å¥½å‹ç³»ç»Ÿï¼š**
- åªèƒ½æœç´¢æœ‰é™çš„ç”¨æˆ·ä¿¡æ¯
- å¥½å‹å…³ç³»å¯¹ç§°
- è¯·æ±‚çŠ¶æ€éªŒè¯

**ç¬”è®°å…±äº«ï¼š**
- åªèƒ½å…±äº«ç»™å¥½å‹
- æƒé™çº§åˆ«æ§åˆ¶
- æ‰€æœ‰è€…ä¿ç•™å®Œå…¨æ§åˆ¶æƒ

**é˜²æ­¢æ”»å‡»ï¼š**
- SQL æ³¨å…¥ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- XSSï¼ˆReact è‡ªåŠ¨è½¬ä¹‰ï¼‰
- CSRFï¼ˆNext.js å†…ç½®ä¿æŠ¤ï¼‰
- æœªæˆæƒè®¿é—®ï¼ˆRLS + ä¸šåŠ¡é€»è¾‘ï¼‰

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•ï¼ˆå»ºè®®ï¼‰

```typescript
// friends.test.ts
describe('sendFriendRequest', () => {
  it('should create friend request', ...)
  it('should reject self-friending', ...)
  it('should detect existing friendship', ...)
})
```

### é›†æˆæµ‹è¯•ï¼ˆå»ºè®®ï¼‰

```typescript
// friends-api.test.ts
describe('POST /api/friends', () => {
  it('should send request', ...)
  it('should return 401 if not authenticated', ...)
})
```

### æ‰‹åŠ¨æµ‹è¯•æ¸…å•

å‚è§ `PHASE3_COMPLETE.md` ä¸­çš„æµ‹è¯•æ¸…å•ã€‚

---

## éƒ¨ç½²è€ƒè™‘

### ç¯å¢ƒå˜é‡

ç¡®ä¿é…ç½®ï¼š
```env
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
DEEPSEEK_API_KEY=...
DOUBAO_API_KEY=...
```

### æ•°æ®åº“è¿ç§»

**æ‰§è¡Œé¡ºåºï¼š**
1. `supabase-schema.sql` (Phase 1)
2. `supabase-schema-phase2.sql` (Phase 2)
3. `supabase-schema-phase3.sql` (Phase 3)

**æ³¨æ„äº‹é¡¹ï¼š**
- æ¯ä¸ª SQL æ–‡ä»¶éƒ½æ˜¯å¹‚ç­‰çš„
- å¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œ
- åŒ…å« IF NOT EXISTS æ£€æŸ¥

### ç”Ÿäº§ä¼˜åŒ–

1. **å¯ç”¨ç”Ÿäº§æ¨¡å¼**
```bash
npm run build
npm start
```

2. **é…ç½®ç¼“å­˜**
- é™æ€èµ„æº CDN
- API å“åº”ç¼“å­˜
- æ•°æ®åº“è¿æ¥æ± 

3. **ç›‘æ§**
- é”™è¯¯è¿½è¸ªï¼ˆSentryï¼‰
- æ€§èƒ½ç›‘æ§ï¼ˆVercel Analyticsï¼‰
- æ•°æ®åº“ç›‘æ§ï¼ˆSupabase Dashboardï¼‰

---

## æœªæ¥æ‰©å±•

### æ½œåœ¨åŠŸèƒ½

1. **é€šçŸ¥ç³»ç»Ÿ**
- å¥½å‹è¯·æ±‚é€šçŸ¥
- ç¬”è®°å…±äº«é€šçŸ¥
- è¯„è®ºé€šçŸ¥

2. **åä½œç¼–è¾‘**
- å®æ—¶åŒæ­¥
- å†²çªè§£å†³
- ç‰ˆæœ¬å†å²

3. **æƒé™ç»†åŒ–**
- å­—æ®µçº§æƒé™
- æ—¶é—´é™åˆ¶
- è®¿é—®ç»Ÿè®¡

4. **ç¤¾äº¤åŠŸèƒ½**
- å…³æ³¨/ç²‰ä¸
- å…¬å¼€ç¬”è®°
- ç¤¾åŒºè®¨è®º

### æŠ€æœ¯æ”¹è¿›

1. **å®æ—¶åŠŸèƒ½**
- Supabase Realtime
- WebSocket è¿æ¥
- å®æ—¶åä½œ

2. **ç¦»çº¿æ”¯æŒ**
- Service Worker
- æœ¬åœ°ç¼“å­˜
- åŒæ­¥ç­–ç•¥

3. **æ€§èƒ½ä¼˜åŒ–**
- è™šæ‹Ÿæ»šåŠ¨
- å¢é‡åŠ è½½
- ä»£ç åˆ†å‰²

---

## æ€»ç»“

Phase 3 æˆåŠŸå®ç°äº†ï¼š

âœ… **å®Œæ•´çš„å¥½å‹ç³»ç»Ÿ**  
âœ… **å®‰å…¨çš„ç¬”è®°å…±äº«**  
âœ… **æ ‡å‡†çš„ MCP é›†æˆ**  
âœ… **å¢å¼ºçš„ AI èƒ½åŠ›**  
âœ… **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ**  
âœ… **ç”Ÿäº§çº§åˆ«çš„ä»£ç è´¨é‡**  

**å…³é”®æˆå°±ï¼š**
- ä»ä¸ªäººå·¥å…·åˆ°åä½œå¹³å°
- å®‰å…¨æ€§ä¸æ˜“ç”¨æ€§çš„å¹³è¡¡
- å¯æ‰©å±•çš„æ¶æ„è®¾è®¡
- å®Œæ•´çš„åŠŸèƒ½å®ç°

**æŠ€æœ¯äº®ç‚¹ï¼š**
- æ•°æ®åº“è®¾è®¡ä¼˜é›…
- RLS ç­–ç•¥å®Œå–„
- API è®¾è®¡æ ‡å‡†
- å‰ç«¯ä½“éªŒæµç•…
- MCP åè®®é›†æˆ

**ä»£ç è´¨é‡ï¼š**
- TypeScript ç±»å‹å®‰å…¨
- 0 Lint é”™è¯¯
- æ„å»ºæˆåŠŸ
- æ–‡æ¡£å®Œæ•´

---

**Phase 3 æŠ€æœ¯å®ç°åœ†æ»¡å®Œæˆï¼** ğŸ‰

